<meta-runner name="OctopusCallGitHubAction">
    <description>Call a gitHub action</description>
    <settings>
        <parameters>
            <param name="LABELING_PATTERN" value="" />
            <param name="CURRENT_COMMIT" value="" />
            <param name="OCTOPUS_GITHUB_TOKEN" value="" />
        </parameters>
        <build-runners>
            <runner name="Call a github action" type="kotlinScript">
                <parameters>
                    <param name="kotlinArgs" value="octopusden octopus-employee-service %OCTOPUS_GITHUB_TOKEN% %CURRENT_COMMIT% %LABELING_PATTERN%" />
                    <param name="kotlinPath" value="%teamcity.tool.kotlin.compiler.DEFAULT%" />
                    <param name="scriptContent"><![CDATA[@file:Repository("https://jcenter.bintray.com")
@file:DependsOn("khttp:khttp:1.0.0")

import khttp.post

val request = post("https://api.github.com/repos/${args[0]}/${args[1]}/dispatches",
        mapOf("Authorization" to "Bearer ${args[2]}")
    , emptyMap(), """{
        "event_type": "release",
        "client_payload": {
        "commit": "${args[3]}",
        "build_version": "${args[4]}"
    }""")
    if (request.statusCode / 100 > 2) {
        throw Exception(request.text)
    }]]></param>
                    <param name="scriptType" value="customScript" />
                    <param name="teamcity.step.mode" value="default" />
                </parameters>
            </runner>
        </build-runners>
        <requirements />
    </settings>
</meta-runner>