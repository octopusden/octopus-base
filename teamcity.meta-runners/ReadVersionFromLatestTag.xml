<meta-runner name="Read a version of the current tag">
  <description>Use current connection of VCS and read a version of the latest tag.</description>
  <settings>
    <parameters>
      <param name="CURRENT_COMMIT" value="" />
      <param name="VERSION_TAG" value="" />
    </parameters>
    <build-runners>
      <runner name="Read current tag" type="kotlinScript">
        <parameters>
          <param name="kotlinPath" value="%teamcity.tool.kotlin.compiler.DEFAULT%" />
          <param name="scriptContent"><![CDATA[import java.io.BufferedReader
import java.io.InputStreamReader

var command = "git tag -l --sort=-v:refname v[0-9,\\.]*"
println(command)
var process = Runtime.getRuntime().exec(command)
var br = BufferedReader(InputStreamReader( process.inputStream))
var stdError = BufferedReader(InputStreamReader(process.getErrorStream()))
var result = br.readLine() ?: ""
println("##teamcity[setParameter name='VERSION_TAG' value='$result']")

command = "git rev-parse HEAD"
println(command)
process = Runtime.getRuntime().exec(command)
br = BufferedReader(InputStreamReader( process.inputStream))
stdError = BufferedReader(InputStreamReader(process.getErrorStream()))
result = br.readLine() ?: throw Exception(stdError.readLine())
println("##teamcity[setParameter name='CURRENT_COMMIT' value='$result']")]]></param>
          <param name="scriptType" value="customScript" />
          <param name="teamcity.step.mode" value="default" />
        </parameters>
      </runner>
    </build-runners>
    <requirements />
  </settings>
</meta-runner>